#include "fdacoefs.h"
#include "usart.h"
#include "stdio.h"
#include "math.h"
#include "delay.h"       //延时

/****Fir带通滤波器****/

u8 str[20];



static float32_t firStateF32[BLOCK_SIZE+NUM_TAPS-1];                     //状态缓存,大小numTaps+blocksize-1
extern __IO uint32_t sys_tick;

uint32_t BlockSize = BLOCK_SIZE;
uint32_t NumBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;       //需要调用arm_fir_f32的个数

//带通滤波器系数 通过matlab中fadtool获取
const float firCoeffs32BP[NUM_TAPS] = {
  -4.02355167e-18,-0.0002167886851,0.0002334306191,-0.0001085307667,-0.000197737565,
  0.0002421259414,-0.0002313822042,-0.0001643332798,0.0002295286977,  -0.0003739729,
  -0.0001120402376,0.0001802978368,-0.0005358748022,-3.799499245e-05,7.422196359e-05,
  -0.0007085889811,5.500560655e-05,-0.0001105084011,-0.0008750632405,0.0001548188156,
  -0.0003925605561,-0.001011382905,0.0002375040203,-0.000781987852,-0.001090690494,
  0.0002669276437,-0.001275015413,-0.001088965219, 0.000196978348, -0.00185017637,
  -0.0009918835713,-2.345276516e-05,-0.002466815757,-0.0008016679203,-0.0004430462141,
  -0.003066720907,-0.0005426559946,-0.001098975772,-0.003579220036,-0.0002643516345,
  -0.002007371746,-0.003929579165,-4.093794996e-05,-0.003154772101,-0.004049967509,
  3.334939538e-05,-0.004492065869,-0.003891782137,-0.0001469568815,-0.005932255648,
  -0.003437753534,-0.0006861003349,-0.007352983113,-0.002712104935,-0.001672159997,
  -0.008604183793,-0.001787135028,-0.003161241766,-0.009520569816,-0.0007849354297,
  -0.005162687041, -0.00993792247,0.0001264423045,-0.007627177052,-0.009711577557,
   0.000742283708, -0.01043929439,-0.008735014126,0.0008349675918,  -0.0134154465,
  -0.006956274621,0.0001701684232, -0.01630702242, -0.00439001061,-0.001477652346,
   -0.01880714484,-0.001123345923,-0.004315169062, -0.02055698819, 0.002685626736,
  -0.008533061482, -0.02114317194, 0.006817069836, -0.01433623116, -0.02006715536,
    0.01100578159,  -0.0220359806, -0.01663658768,  0.01496328972, -0.03230972961,
  -0.009614880197,   0.0184034761, -0.04704660922, 0.004086516798,   0.0210690517,
   -0.07320410758,  0.03666734695,  0.02275601216,  -0.1612126082,   0.2474640459,
     0.6900013685,   0.2474640459,  -0.1612126082,  0.02275601216,  0.03666734695,
   -0.07320410758,   0.0210690517, 0.004086516798, -0.04704660922,   0.0184034761,
  -0.009614880197, -0.03230972961,  0.01496328972, -0.01663658768,  -0.0220359806,
    0.01100578159, -0.02006715536, -0.01433623116, 0.006817069836, -0.02114317194,
  -0.008533061482, 0.002685626736, -0.02055698819,-0.004315169062,-0.001123345923,
   -0.01880714484,-0.001477652346, -0.00439001061, -0.01630702242,0.0001701684232,
  -0.006956274621,  -0.0134154465,0.0008349675918,-0.008735014126, -0.01043929439,
   0.000742283708,-0.009711577557,-0.007627177052,0.0001264423045, -0.00993792247,
  -0.005162687041,-0.0007849354297,-0.009520569816,-0.003161241766,-0.001787135028,
  -0.008604183793,-0.001672159997,-0.002712104935,-0.007352983113,-0.0006861003349,
  -0.003437753534,-0.005932255648,-0.0001469568815,-0.003891782137,-0.004492065869,
  3.334939538e-05,-0.004049967509,-0.003154772101,-4.093794996e-05,-0.003929579165,
  -0.002007371746,-0.0002643516345,-0.003579220036,-0.001098975772,-0.0005426559946,
  -0.003066720907,-0.0004430462141,-0.0008016679203,-0.002466815757,-2.345276516e-05,
  -0.0009918835713, -0.00185017637, 0.000196978348,-0.001088965219,-0.001275015413,
  0.0002669276437,-0.001090690494,-0.000781987852,0.0002375040203,-0.001011382905,
  -0.0003925605561,0.0001548188156,-0.0008750632405,-0.0001105084011,5.500560655e-05,
  -0.0007085889811,7.422196359e-05,-3.799499245e-05,-0.0005358748022,0.0001802978368,
  -0.0001120402376,  -0.0003739729,0.0002295286977,-0.0001643332798,-0.0002313822042,
  0.0002421259414,-0.000197737565,-0.0001085307667,0.0002334306191,-0.0002167886851,
  -4.02355167e-18
};


arm_fir_instance_f32 S;
float32_t *inputF32,*outputF32;

//fir滤波初始化
void ecg_fir_tilter_init(void)
{
	arm_fir_init_f32(&S,NUM_TAPS,(float32_t*)&firCoeffs32BP[0],&firStateF32[0],BlockSize);	
}

//fir滤波函数
float ecg_fir_tilter(float input)
{
	float output;
	/*实现FIR滤波*/
	arm_fir_f32(&S,&input,&output,BlockSize);
	return output;
}

